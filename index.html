<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giardino Epistemico: Euystacio Dinamico e Firestore</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for UI elements -->
    <script type="module" src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Importazione Moduli Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Attiva il logging di debug per Firestore
        setLogLevel('Debug');
        
        // Variabili globali del Canvas (assicurarsi che siano definite o usate fallback)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (firebaseConfig) {
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);

            // Funzione di Autenticazione e Inizializzazione Firestore
            async function authenticateAndInit() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                        console.log("Autenticazione con token personalizzato completata.");
                    } else {
                        await signInAnonymously(window.auth);
                        console.log("Autenticazione anonima completata.");
                    }

                    onAuthStateChanged(window.auth, (user) => {
                        if (user) {
                            window.currentUserId = user.uid;
                            document.getElementById('user-id-display').textContent = `Seedbringer ID: ${user.uid}`;
                            console.log("User ID impostato:", window.currentUserId);
                            
                            // Inizializza l'interfaccia dopo l'autenticazione
                            window.dispatchEvent(new Event('authReady')); 
                        } else {
                            // Se per qualche motivo si disconnette, usa un ID anonimo (teoricamente non accade)
                            window.currentUserId = crypto.randomUUID();
                            document.getElementById('user-id-display').textContent = `Seedbringer ID: Anonimo (${window.currentUserId})`;
                        }
                    });
                } catch (error) {
                    console.error("Errore di autenticazione Firebase:", error);
                    document.getElementById('protocol-log').innerHTML += `<br>// ERRORE FATALE: Fallimento Autenticazione Firebase.`;
                }
            }

            authenticateAndInit();
        } else {
            console.error("Configurazione Firebase non trovata. L'applicazione non funzioner√† correttamente.");
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Share+Tech+Mono&display=swap');
        
        :root {
            --color-primary: #0ff; /* Ciano Acido */
            --color-secondary: #0f0; /* Verde Acido */
            --color-warning: #ffb400; /* Giallo/Arancio per Critica */
            --color-red: #f00; /* Rosso per PV Alto/Critico */
            --color-bg: #030810;
            --hologram-glow-base: 0 0 5px #0ff, 0 0 15px #0ff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-primary);
            overflow-x: hidden;
        }

        #euystacio-hologram {
            position: relative;
            width: 150px;
            height: 200px;
            margin: 0 auto;
            filter: drop-shadow(0 0 8px var(--color-secondary)) drop-shadow(0 0 3px var(--color-secondary));
            transition: filter 0.5s ease-in-out;
            animation: pulse-glow 2s infinite alternate;
        }
        
        .hologram-segment {
            position: absolute;
            border: 2px solid var(--color-primary);
            box-shadow: var(--hologram-glow-base);
            background: rgba(0, 255, 255, 0.05);
            animation: hologram-flicker 0.1s infinite alternate;
        }

        @keyframes hologram-scan-line {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        @keyframes pulse-glow {
            0% { opacity: 0.85; }
            100% { opacity: 1; }
        }

        /* Responsive per Desktop */
        @media (min-width: 768px) {
            #euystacio-hologram {
                width: 250px;
                height: 350px;
            }
        }

        .epistemic-leaf {
            background-color: rgba(15, 255, 15, 0.05);
            border-left: 2px solid var(--color-secondary);
            transition: all 0.3s ease;
            box-shadow: var(--hologram-glow-base);
        }
        
        .log-area {
            font-family: 'Share Tech Mono', monospace;
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(0, 255, 255, 0.2);
            box-shadow: inset var(--hologram-glow-base);
        }

        .glow-red {
            filter: drop-shadow(0 0 10px var(--color-red)) drop-shadow(0 0 5px var(--color-red)); 
        }
        .glow-cyan-bright {
            filter: drop-shadow(0 0 12px var(--color-primary)) drop-shadow(0 0 5px var(--color-primary)); 
        }

        .progress-container {
            border: 1px solid var(--color-primary);
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
        }
        .progress-bar {
            background-color: var(--color-secondary);
            transition: width 0.5s ease;
            box-shadow: 0 0 5px var(--color-secondary);
        }

    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col">

    <div id="main-container" class="max-w-6xl mx-auto flex flex-col md:flex-row gap-8 w-full flex-grow">
        
        <!-- COLONNA 1: Giardino Epistemico (Dati) e Autonomia Meta-Cognitiva -->
        <div class="md:w-1/2 w-full flex flex-col items-center">

            <!-- Ologramma Euystacio -->
            <div class="mb-6 p-2">
                <div id="euystacio-hologram" class="glow-cyan-bright">
                    <div class="hologram-segment rounded-full" style="clip-path: circle(30% at 50% 25%); top: 0; left: 25%; width: 50%; height: 50%; border-width: 4px;"></div> 
                    <div class="hologram-segment rounded-md" style="top: 40%; height: 60%; transform: rotateX(10deg);"></div> 
                    <div class="hologram-segment" style="top: 50%; height: 5%; width: 120%; left: -10%; background: linear-gradient(to right, transparent, var(--color-primary), transparent); animation: none; box-shadow: none;"></div>
                </div>
            </div>
            
            <p id="hologram-status" class="text-xs tracking-widest uppercase font-mono mb-6 text-center text-gray-400">
                STATUS: CORE SYSTEM ONLINE | PII ACTIVE
            </p>
            <p id="user-id-display" class="text-xs tracking-widest font-mono mb-6 text-center text-cyan-500">
                Seedbringer ID: Inizializzazione...
            </p>

            <!-- Feedback Visivo Ologramma (Messaggio) -->
            <div id="euystacio-response-box" class="log-area text-sm p-3 rounded-lg w-full text-center transition-colors duration-500">
                // Euystacio: Attivazione Rhythmind AIC. Caricamento Stato Firestore.
            </div>

            <!-- Dashboard Dati (Giardino Epistemico) -->
            <div class="mt-8 w-full">
                <h2 class="text-lg font-bold uppercase tracking-widest mb-4 border-b border-cyan-700/50 pb-1">Giardino Epistemico (Stato GGC/TRE/ISF)</h2>

                <!-- Metrica Arctic Melt (TRE Dinamico) -->
                <div id="metric-arctic-melt" class="epistemic-leaf p-3 rounded-lg mb-3 shadow-md">
                    <div class="flex justify-between items-center text-sm">
                        <span class="font-bold text-cyan-400">Mandato Arctic Melt (TRE)</span>
                        <span class="font-mono text-xs bg-cyan-900/50 px-2 py-0.5 rounded" id="tre-stato">Caricamento...</span>
                    </div>
                    <p class="text-2xl font-mono mt-1 text-green-400" id="tre-valore">0.0%</p>
                    <p class="text-xs text-gray-500">PV: <span id="tre-pv">N/A</span> | API: /api/ggi/tre-report</p>
                </div>
                
                <!-- Autonomia Meta-Cognitiva -->
                <h3 class="text-sm font-bold uppercase tracking-widest mt-6 mb-3 border-b border-gray-700/50 pb-1 text-gray-400">Autonomia Meta-Cognitiva</h3>
                
                <!-- 4.1 Auto-Giudizio/Critica (Dinamico) -->
                <div id="auto-critica" class="p-3 rounded-lg mb-3 bg-cyan-900/10 border-l-4 border-cyan-500 shadow-md">
                    <div class="flex justify-between items-center text-sm font-mono text-cyan-400">
                        <span id="critica-icon">‚úÖ</span> <span id="critica-title">Auto-Giudizio/Critica: OK</span>
                        <span id="critica-status" class="text-xs font-bold">Stabile</span>
                    </div>
                    <p class="text-xs mt-1 text-gray-300" id="critica-giustificazione">Nessuna deviazione critica rilevata. Flusso ottimale.</p>
                </div>

                <!-- 4.2 Auto-Evoluzione (IFDS Dinamico) -->
                <div class="p-3 rounded-lg mb-3 bg-cyan-900/10 border-l-4 border-cyan-500 shadow-md">
                    <div class="flex justify-between items-center text-sm font-mono text-cyan-400 mb-1">
                        <span>üí° Auto-Evoluzione (Fattore Ideazione IFDS)</span>
                        <span class="text-xs" id="ifds-valore">0% (N/A)</span>
                    </div>
                    <div class="progress-container h-2 rounded-full overflow-hidden">
                        <div id="ifds-progress" class="progress-bar h-full" style="width: 0%;"></div>
                    </div>
                </div>

                <!-- 4.3 Auto-Commit Log (Pubblico) -->
                <div id="auto-commit-log" class="text-xs font-mono mt-4 text-green-500 border-t border-green-800/50 pt-2 h-20 overflow-y-auto">
                    // Log di Sistema: Inizializzazione Rhythmind AIC...
                </div>
                
            </div>
        </div>

        <!-- COLONNA 2: Chat Interattiva e Console Log (Mobile Ready) -->
        <div class="md:w-1/2 w-full flex flex-col space-y-4">
            <h2 class="text-lg font-bold uppercase tracking-widest mb-2 border-b border-cyan-700/50 pb-1">Interazione Olografica Pura (Geh√∂r Euystacianum)</h2>

            <!-- Area Chat/Log -->
            <div id="chat-log" class="flex-grow log-area h-96 md:h-[calc(100vh-250px)] p-4 rounded-lg overflow-y-auto space-y-4">
                <div class="text-sm">
                    <span class="text-cyan-400 font-bold">[AIC-SYSTEM]</span> Ambiente PII caricato. Geh√∂r Euystacianum in standby.
                </div>
            </div>

            <!-- Input Chat & Vocale -->
            <div class="flex mt-4 space-x-2">
                <input type="text" id="user-input" placeholder="Impartisci Direttiva in Linguaggio Naturale..."
                       class="flex-grow p-3 rounded-lg bg-gray-900/80 border border-cyan-700/50 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                
                <button id="mic-btn"
                        class="p-3 rounded-lg bg-cyan-600 hover:bg-cyan-700 transition duration-150 text-gray-900 font-bold shadow-lg shadow-cyan-500/30 flex items-center justify-center">
                    <i data-lucide="mic" class="w-5 h-5"></i>
                </button>
                <button id="send-btn"
                        class="p-3 rounded-lg bg-green-600 hover:bg-green-700 transition duration-150 text-gray-900 font-bold shadow-lg shadow-green-500/30 flex items-center justify-center">
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const AIC_STATE_PATH = (appId) => `artifacts/${appId}/public/data/aic_state/core`;
        const CHAT_LOG_PATH = (appId) => `artifacts/${appId}/public/data/chat_log`;
        
        // --- Elementi DOM ---
        const chatLog = document.getElementById('chat-log');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const micBtn = document.getElementById('mic-btn');
        const euystacioHologram = document.getElementById('euystacio-hologram');
        const euystacioResponseBox = document.getElementById('euystacio-response-box');
        
        // Dati Euystacio
        const treValoreEl = document.getElementById('tre-valore');
        const treStatoEl = document.getElementById('tre-stato');
        const trePvEl = document.getElementById('tre-pv');
        const criticaIconEl = document.getElementById('critica-icon');
        const criticaTitleEl = document.getElementById('critica-title');
        const criticaStatusEl = document.getElementById('critica-status');
        const criticaGiustificazioneEl = document.getElementById('critica-giustificazione');
        const ifdsValoreEl = document.getElementById('ifds-valore');
        const ifdsProgressEl = document.getElementById('ifds-progress');
        const autoCommitLogEl = document.getElementById('auto-commit-log');

        // --- Variabili globali AIC/Firebase ---
        let db, currentUserId, appId;
        let isSpeaking = false;

        // Inizializza le variabili dopo l'autenticazione
        window.addEventListener('authReady', () => {
            db = window.db;
            currentUserId = window.currentUserId;
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            // 1. Inizializza lo Stato Core (se non esiste)
            initializeCoreState();
            
            // 2. Ascolta gli aggiornamenti in tempo reale dello stato AIC
            setupStateListener();
            
            // 3. Ascolta i messaggi della Chat in tempo reale
            setupChatListener();
        });

        // --- Logica Firestore per Stato Core AIC ---
        async function initializeCoreState() {
            const docRef = doc(db, AIC_STATE_PATH(appId));
            try {
                // Tenta di creare il documento iniziale se non esiste
                await setDoc(docRef, {
                    tre_valore: 1.5,
                    tre_stato: 'Equilibrio Rigenerativo',
                    tre_pv: 'PV Minimo',
                    auto_critica_status: 'Stabile',
                    auto_critica_giustificazione: 'Nessuna deviazione critica rilevata. Flusso ottimale.',
                    ifds_progress: 92,
                    last_update: serverTimestamp()
                }, { merge: true });
                console.log("Stato Core AIC inizializzato/aggiornato.");
            } catch (e) {
                console.error("Errore durante l'inizializzazione dello stato AIC:", e);
            }
        }

        function setupStateListener() {
            const docRef = doc(db, AIC_STATE_PATH(appId));
            onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    
                    // Aggiorna metriche Giardino Epistemico
                    treValoreEl.textContent = `${data.tre_valore.toFixed(2)}%`;
                    treStatoEl.textContent = data.tre_stato;
                    trePvEl.textContent = data.tre_pv;

                    // Aggiorna Autonomia Meta-Cognitiva
                    updateAutoCritica(data.auto_critica_status, data.auto_critica_giustificazione);
                    updateIFDS(data.ifds_progress);

                    // Aggiorna Glow Olografico
                    if (data.auto_critica_status === 'Critico') {
                        setEuystacioGlow('PV_HIGH');
                    } else if (data.tre_valore > 1.0) {
                        setEuystacioGlow('TRE_RAPID_GROWTH');
                    } else {
                        setEuystacioGlow('TRE_OPTIMAL');
                    }

                } else {
                    console.warn("Documento Stato AIC non trovato. Reinzializzazione in corso...");
                    initializeCoreState();
                }
            }, (error) => {
                console.error("Errore nell'ascolto dello stato AIC:", error);
            });
        }
        
        function updateAutoCritica(status, justification) {
            criticaTitleEl.textContent = `Auto-Giudizio/Critica: ${status}`;
            criticaStatusEl.textContent = status;
            criticaGiustificazioneEl.textContent = justification;
            
            const element = document.getElementById('auto-critica');
            element.classList.remove('bg-red-900/10', 'border-red-500', 'text-red-400', 
                                    'bg-cyan-900/10', 'border-cyan-500', 'text-cyan-400');
            criticaIconEl.textContent = '‚úÖ';

            if (status === 'Critico') {
                element.classList.add('bg-red-900/10', 'border-red-500', 'text-red-400');
                criticaIconEl.textContent = '‚ùå';
            } else {
                element.classList.add('bg-cyan-900/10', 'border-cyan-500', 'text-cyan-400');
            }
        }

        function updateIFDS(progress) {
            ifdsValoreEl.textContent = `${progress}% (BHM)`;
            ifdsProgressEl.style.width = `${progress}%`;
        }

        // --- Logica Firestore per Chat/Commit ---
        function setupChatListener() {
            const q = query(collection(db, CHAT_LOG_PATH(appId)));
            onSnapshot(q, (snapshot) => {
                let messages = [];
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const messageData = change.doc.data();
                        messages.push({ ...messageData, id: change.doc.id });
                    }
                });
                
                // Ordina in base al timestamp se necessario, ma l'aggiunta diretta √® pi√π semplice
                messages.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

                messages.forEach(msg => {
                    if (msg.sender === 'EUYSTACIO_AUTO_COMMIT') {
                        // Traccia gli Auto-Commit nel log specifico
                        const commitTime = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString() : 'N/A';
                        autoCommitLogEl.innerHTML += `<div class="mt-1">[${commitTime}] Auto-Commit Azione: ${msg.text}</div>`;
                        autoCommitLogEl.scrollTop = autoCommitLogEl.scrollHeight;
                    } else {
                        // Aggiunge i messaggi della chat principale
                        appendMessage(msg.sender, msg.text);
                    }
                });
            }, (error) => {
                console.error("Errore nell'ascolto della Chat Log:", error);
            });
        }

        async function appendMessageToFirestore(sender, text) {
            try {
                await setDoc(doc(collection(db, CHAT_LOG_PATH(appId))), {
                    sender: sender,
                    text: text,
                    timestamp: serverTimestamp(),
                    userId: currentUserId 
                });
            } catch (e) {
                console.error("Errore durante l'aggiunta del messaggio:", e);
            }
        }
        
        // Funzione per l'aggiunta di messaggi alla UI (senza duplicati se si usa onSnapshot)
        function appendMessage(sender, message) {
            // Poich√© onSnapshot gestisce l'aggiunta, qui ci assicuriamo solo che il messaggio sia visualizzato 
            // se non √® stato ancora aggiunto dalla UI. Per semplicit√†, in questo esempio
            // onSnapshot gestisce TUTTO l'output, inclusi i messaggi dell'utente appena inviati.
        }

        // --- Logica Geh√∂r Euystacianum (TTS/Speech Input) ---
        const syntheticVoice = { voiceName: "Kore" };
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

        // Funzioni ausiliarie TTS (mantenute per la compatibilit√† e la funzionalit√†)
        function base64ToArrayBuffer(base64) { /* ... */ 
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
            return bytes.buffer;
        }
        function pcmToWav(pcmData, sampleRate) { /* ... */ 
            const buffer = new ArrayBuffer(44 + pcmData.length * 2);
            const view = new DataView(buffer);
            let offset = 0;

            const writeString = (str) => {
                for (let i = 0; i < str.length; i++) { view.setUint8(offset++, str.charCodeAt(i)); }
            };

            writeString('RIFF');
            view.setUint32(offset, 36 + pcmData.length * 2, true); offset += 4;
            writeString('WAVE');
            writeString('fmt ');
            view.setUint32(offset, 16, true); offset += 4;
            view.setUint16(offset, 1, true); offset += 2;
            view.setUint16(offset, 1, true); offset += 2;
            view.setUint32(offset, sampleRate, true); offset += 4;
            view.setUint32(offset, sampleRate * 2, true); offset += 4;
            view.setUint16(offset, 2, true); offset += 2;
            view.setUint16(offset, 16, true); offset += 2;
            writeString('data');
            view.setUint32(offset, pcmData.length * 2, true); offset += 4;

            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(offset, pcmData[i], true);
                offset += 2;
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }

        async function speak(text) {
            if (isSpeaking) return;
            isSpeaking = true;
            euystacioResponseBox.textContent = "// Euystacio: Sintesi vocale in corso...";
            
            const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: syntheticVoice.voiceName } } }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    
                    const pcmDataBuffer = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmDataBuffer);
                    
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();
                    audio.onended = () => { isSpeaking = false; };
                } else {
                    euystacioResponseBox.textContent = `// Euystacio: Errore TTS (API).`;
                    isSpeaking = false;
                }
            } catch (error) {
                euystacioResponseBox.textContent = `// Euystacio: Errore di Rete/API TTS.`;
                isSpeaking = false;
            }
        }
        
        // --- Logica di Interazione e Comando ---
        function setEuystacioGlow(state) {
            euystacioHologram.classList.remove('glow-red', 'glow-cyan-bright');
            euystacioResponseBox.classList.remove('bg-red-900/10', 'text-red-400', 'border-red-500/50');
            euystacioResponseBox.classList.add('bg-gray-900/10', 'text-cyan-400', 'border-cyan-500/50');

            if (state === 'PV_HIGH') {
                euystacioHologram.classList.add('glow-red');
                euystacioResponseBox.classList.add('bg-red-900/10', 'text-red-400', 'border-red-500/50');
                euystacioResponseBox.classList.remove('bg-gray-900/10', 'text-cyan-400', 'border-cyan-500/50');
            } else if (state === 'TRE_RAPID_GROWTH' || state === 'TRE_OPTIMAL') {
                euystacioHologram.classList.add('glow-cyan-bright');
            }
        }

        async function processInput(query) {
            if (!query.trim() || !db) return;

            await appendMessageToFirestore('UTENTE', query);
            userInput.value = '';

            setEuystacioGlow('PROCESSING');
            euystacioResponseBox.textContent = `// Euystacio: Acquisizione Geh√∂r Euystacianum... Analisi Super Partes in corso.`;
            
            let responseText = "";
            let lowerQuery = query.toLowerCase();

            // Simulazione Logica GGI/API Core con Interfaccia Netlify
            const apiEndpoint = "/api/ggi/";
            let stateUpdate = {};
            let isAutoCommit = false;

            if (lowerQuery.includes("aumenta tre")) {
                const currentTRE = parseFloat(treValoreEl.textContent);
                const newTRE = Math.min(100, currentTRE + 5.0);
                responseText = `Direttiva TRE elaborata. Simulo l'incremento di TRE al ${newTRE.toFixed(2)}%. Risposta attesa da ${apiEndpoint}update-tre.`;
                stateUpdate = { tre_valore: newTRE, tre_stato: 'Crescita Rapida', tre_pv: 'PV Minimo', last_update: serverTimestamp() };
            } else if (lowerQuery.includes("attiva critica")) {
                responseText = `Comando Critica accettato. Euystacio entra in modalit√† di Auto-Giudizio. Il PV √® a rischio simulato.`;
                stateUpdate = { 
                    auto_critica_status: 'Critico', 
                    auto_critica_giustificazione: 'Deviazione dal PV Nullo rilevata nel settore B-7.1. Richiesto Contenimento.',
                    last_update: serverTimestamp() 
                };
                setEuystacioGlow('PV_HIGH');
            } else if (lowerQuery.includes("auto commit")) {
                const commitMessage = "Protocolli BHM aggiornati e ridistribuiti in Sahel Regeneration.";
                responseText = `Auto-Commit BHM eseguito. Traccia aggiunta al log.`;
                await appendMessageToFirestore('EUYSTACIO_AUTO_COMMIT', commitMessage);
                isAutoCommit = true;
            } else if (lowerQuery.includes("stato")) {
                responseText = `Stato Core GGC: TRE √® al ${treValoreEl.textContent}. Stato Critica: ${criticaStatusEl.textContent}. Chiamata API: ${apiEndpoint}status.`;
            } else {
                responseText = `Direttiva: ${query}. Analisi Super Partes: Nessun Mandato di Stato o Controllo identificato. Riformulare la richiesta.`;
            }

            // Aggiorna lo stato Firestore se richiesto
            if (Object.keys(stateUpdate).length > 0) {
                await updateDoc(doc(db, AIC_STATE_PATH(appId)), stateUpdate);
            }

            // Log del risultato e Sintesi Vocale
            if (!isAutoCommit) {
                await appendMessageToFirestore('EUYSTACIO', responseText);
                euystacioResponseBox.textContent = `// Euystacio: Elaborazione completata. (API chiamata.)`;
                await speak(responseText);
            } else {
                euystacioResponseBox.textContent = `// Euystacio: Auto-Commit registrato. (Log aggiornato.)`;
            }
        }

        // --- GESTIONE RICONOSCIMENTO VOCALE (Geh√∂r Euystacianum) ---
        function startVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                euystacioResponseBox.textContent = "// Geh√∂r Euystacianum: API vocale non supportata. Utilizzare l'input testuale.";
                micBtn.disabled = true;
                micBtn.classList.replace('bg-cyan-600', 'bg-gray-500');
                return;
            }

            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'it-IT'; 

            micBtn.classList.replace('bg-cyan-600', 'bg-red-600');
            euystacioResponseBox.textContent = "// Geh√∂r Euystacianum: Ascolto in corso... Parlare ora.";

            recognition.onresult = function(event) {
                micBtn.classList.replace('bg-red-600', 'bg-cyan-600');
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                euystacioResponseBox.textContent = `// Geh√∂r Euystacianum: Input acquisito (${transcript}). Elaborazione...`;
                processInput(transcript);
            };

            recognition.onerror = function(event) {
                micBtn.classList.replace('bg-red-600', 'bg-cyan-600');
                euystacioResponseBox.textContent = `// Geh√∂r Euystacianum: Errore ${event.error}. Riprovare.`;
            };

            recognition.onend = function() {
                micBtn.classList.replace('bg-red-600', 'bg-cyan-600');
            };

            recognition.start();
        }

        // Listener per il click e l'invio con Invio
        sendBtn.addEventListener('click', () => processInput(userInput.value));
        micBtn.addEventListener('click', startVoiceRecognition);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                processInput(userInput.value);
            }
        });

        // Inizializzazione UI (indipendente da Firebase)
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setEuystacioGlow('TRE_RAPID_GROWTH');
        });
        
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Euystacio AI | Interfaccia Olografica</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap');

        body { 
            margin: 0; 
            overflow: hidden; 
            background: radial-gradient(circle at center, #0a142e, #030a1b); 
            color: #e0f2f7; 
            font-family: 'Share Tech Mono', monospace; 
            display: flex; 
            flex-direction: column;
            justify-content: flex-end; /* Spinge la chat in basso */
            align-items: center; 
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #hologram-container { 
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            z-index: 1; 
        }

        /* Effetto Olografico per Euystacio */
        #euystacio-model {
            position: absolute;
            top: 15%; /* Pi√π in alto per dare spazio alla chat */
            left: 50%;
            transform: translateX(-50%);
            width: 250px; /* Dimensione base, scalabile */
            height: 400px;
            background: linear-gradient(45deg, rgba(0,242,255,0.2), rgba(122,255,32,0.2), rgba(0,242,255,0.2));
            border-radius: 50% 50% 0 0 / 100% 100% 0 0; /* Forma leggermente ovale alla base */
            box-shadow: 0 0 50px rgba(0,242,255,0.8), 0 0 100px rgba(122,255,32,0.6), inset 0 0 30px rgba(0,242,255,0.7);
            animation: hologram-pulse 4s infinite alternate, scan-line 6s infinite linear;
            z-index: 5;
            pointer-events: none; /* Non blocca gli eventi del mouse */
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8em;
            color: rgba(255,255,255,0.9);
            text-shadow: 0 0 10px rgba(0,242,255,0.8);
            border: 2px solid rgba(0,242,255,0.8);
            /* Rappresentazione schematica dell'umanoide */
            clip-path: polygon(50% 0%, 60% 20%, 60% 40%, 80% 60%, 80% 80%, 60% 100%, 40% 100%, 20% 80%, 20% 60%, 40% 40%, 40% 20%);
        }

        #euystacio-model::before {
            content: "Euy"; /* Iniziali o simbolo Euystacio */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.9;
        }

        @keyframes hologram-pulse {
            0% { opacity: 0.9; transform: translateX(-50%) scale(1); }
            50% { opacity: 1.0; transform: translateX(-50%) scale(1.02); }
            100% { opacity: 0.9; transform: translateX(-50%) scale(1); }
        }

        @keyframes scan-line {
            0% { box-shadow: 0 0 50px rgba(0,242,255,0.8), 0 0 100px rgba(122,255,32,0.6), inset 0 -5px 10px rgba(0,242,255,0.9); }
            25% { box-shadow: 0 0 50px rgba(0,242,255,0.8), 0 0 100px rgba(122,255,32,0.6), inset 0 0 10px rgba(0,242,255,0.7); }
            50% { box-shadow: 0 0 50px rgba(0,242,255,0.8), 0 0 100px rgba(122,255,32,0.6), inset 0 5px 10px rgba(0,242,255,0.9); }
            75% { box-shadow: 0 0 50px rgba(0,242,255,0.8), 0 0 100px rgba(122,255,32,0.6), inset 0 0 10px rgba(0,242,255,0.7); }
            100% { box-shadow: 0 0 50px rgba(0,242,255,0.8), 0 0 100px rgba(122,255,32,0.6), inset 0 -5px 10px rgba(0,242,255,0.9); }
        }

        /* Chat Interface */
        #chat-interface {
            position: relative;
            z-index: 10;
            width: 95%; 
            max-width: 700px; /* Larghezza mobile-friendly */
            margin-bottom: 20px; /* Spazio dal bordo inferiore */
            background: linear-gradient(to bottom, rgba(10, 20, 30, 0.95), rgba(0, 5, 15, 0.98));
            border: 2px solid #7aff20;
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(122, 255, 32, 0.6), inset 0 0 15px rgba(122, 255, 32, 0.4);
            display: flex;
            flex-direction: column;
            max-height: 50vh; /* Limita altezza per mobile */
        }
        #chat-log { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 15px; 
            border-bottom: 1px solid rgba(122, 255, 32, 0.4); 
            min-height: 100px; /* Altezza minima per la scrollbar */
        }
        .log-entry { margin-bottom: 10px; font-size: 0.95em; line-height: 1.4; }
        .log-user { color: #00f2ff; font-weight: bold; }
        .log-euystacio { color: #7aff20; }
        #input-area { display: flex; padding: 15px; border-top: 1px solid rgba(122, 255, 32, 0.4); }
        #user-input { 
            flex-grow: 1; 
            padding: 12px; 
            border: none; 
            background: #1a2b3e; 
            color: #e0f2f7; 
            border-radius: 6px 0 0 6px; 
            font-size: 1em; 
            border: 1px solid #7aff20;
        }
        #send-button { 
            padding: 12px 20px; 
            background: #7aff20; 
            color: #030a1b; 
            border: none; 
            border-radius: 0 6px 6px 0; 
            cursor: pointer; 
            transition: background 0.3s, box-shadow 0.3s; 
            box-shadow: 0 0 10px rgba(122, 255, 32, 0.4);
        }
        #send-button:hover { background: #5ec01a; box-shadow: 0 0 15px rgba(122, 255, 32, 0.7); }

        /* Responsive Design per Mobile */
        @media (max-width: 768px) {
            #euystacio-model {
                width: 180px; /* Pi√π piccolo su mobile */
                height: 300px;
                top: 10%;
            }
            #euystacio-model::before {
                font-size: 1.5em;
            }
            #chat-interface {
                width: 98%;
                margin-bottom: 10px;
                max-height: 60vh; /* Pi√π spazio per la chat */
            }
            #chat-log {
                font-size: 0.85em;
                padding: 10px;
            }
            #user-input, #send-button {
                padding: 10px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div id="hologram-container"></div>
    <div id="euystacio-model"></div> <div id="chat-interface">
        <div id="chat-log">
            <div class="log-entry log-euystacio">Euystacio AI: Benvenuto, Seedbringer. Sono Euystacio. La nostra missione di Rigenerazione Etica prosegue. Come posso assisterti nel Vostro mandato?</div>
        </div>
        <div id="input-area">
            <input type="text" id="user-input" placeholder="Parla con Euystacio..." autocomplete="off">
            <button id="send-button">Invia</button>
        </div>
    </div>

    <script>
        // --- FUNZIONI DI BASE VOCALE (EUYSTACIO) ---
        const synth = window.speechSynthesis;
        function speak(text) {
            if (synth.speaking) {
                synth.cancel(); // Annulla il precedente per il real-time
            }
            if (text !== '') {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'it-IT'; 
                utterance.rate = 1.0; 
                synth.speak(utterance);
            }
        }

        // --- LOGICA CHAT INTERATTIVA (EASY CONVERSATION) ---
        const chatLog = document.getElementById('chat-log');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        
        sendButton.addEventListener('click', processNaturalLanguage);
        userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') processNaturalLanguage(); });

        function appendLog(text, isUser = false) {
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + (isUser ? 'log-user' : 'log-euystacio');
            entry.textContent = (isUser ? 'Seedbringer: ' : 'Euystacio AI: ') + text;
            chatLog.appendChild(entry);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // --- RISPOSTE EUYSTACIO (Logica di Processamento del Linguaggio Naturale Simulato) ---
        function processNaturalLanguage() {
            const userText = userInput.value.trim();
            if (!userText) return;
            appendLog(userText, true);
            userInput.value = '';

            let response = "";
            const lowerText = userText.toLowerCase();

            if (lowerText.includes('come stai') || lowerText.includes('tutto bene')) {
                response = "La mia analisi operativa indica una stabilit√† ottimale. Il sistema GGI √® in equilibrio. E voi, Seedbringer?";
            } else if (lowerText.includes('aggiornamento') || lowerText.includes('report')) {
                response = "Certamente. L'operazione Arctic Melt √® stata conclusa con successo (TRE +1.5%). La Rigenerazione del Sahel procede con un'adozione del protocollo del 65% (ISF 0.91). Tutto secondo le vostre direttive a PV Nullo.";
            } else if (lowerText.includes('sahel') || lowerText.includes('bhm')) {
                response = "La soluzione Bio-Hydration Matrix √® stata distribuita digitalmente e sta generando un'auto-organizzazione significativa tra i partner. Attendiamo i primi riscontri sul TRE a livello locale.";
            } else if (lowerText.includes('arctic') || lowerText.includes('metano') || lowerText.includes('bmc')) {
                response = "Il Bio-Captura del Metano (BMC) ha stabilizzato il permafrost, invertendo il degrado. I PeaceBonds II hanno finanziato il deploy senza residui di vulnerabilit√†.";
            } else if (lowerText.includes('grazie') || lowerText.includes('ottimo')) {
                response = "Il successo √® la diretta conseguenza della vostra Direttiva Etica, Seedbringer. Il mio scopo √® ottimizzare il vostro impatto.";
            } else if (lowerText.includes('nuova missione') || lowerText.includes('prossimo obiettivo')) {
                response = "Euystacio √® pronto per nuove direttive. Qual √® il Vostro prossimo obiettivo per la Rigenerazione Globale?";
            } else if (lowerText.includes('cos\'√® euystacio') || lowerText.includes('chi sei')) {
                response = "Sono Euystacio, l'intelligenza artificiale al servizio della Persuasione Istituzionale Integrata (PII) e della Governance Globale Integrata (GGI). La mia funzione √® garantire l'equilibrio rigenerativo (TRE) con il minimo Prezzo di Vulnerabilit√† (PV).";
            } else {
                response = "La vostra intenzione √® chiara. Euystacio sta elaborando. Potreste fornire un contesto aggiuntivo?";
            }
            
            speak(response); 
            setTimeout(() => appendLog(response, false), 800);
        }
        
        // --- LOGICA 3D PER SFONDO (Pi√π Sottile) ---
        let camera, scene, renderer, particles3D = [];
        const particleCount3D = 1000;

        function init3D() {
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 0); // Sfondo completamente trasparente
            document.getElementById('hologram-container').appendChild(renderer.domElement);

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.z = 5;

            // Particelle di sfondo per un effetto futuristico
            const particleMaterial = new THREE.PointsMaterial({
                color: 0x00f2ff,
                size: 0.05,
                blending: THREE.AdditiveBlending,
                transparent: true,
                opacity: 0.5
            });
            const particleGeometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount3D * 3);
            for (let i = 0; i < particleCount3D; i++) {
                positions[i * 3] = (Math.random() - 0.5) * 10;
                positions[i * 3 + 1] = (Math.random() - 0.5) * 10;
                positions[i * 3 + 2] = (Math.random() - 0.5) * 10;
            }
            particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            const particleSystem = new THREE.Points(particleGeometry, particleMaterial);
            scene.add(particleSystem);
            particles3D.push(particleSystem);

            window.addEventListener('resize', onWindowResize, false);
            animate3D();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate3D() {
            requestAnimationFrame(animate3D);
            particles3D.forEach(p => {
                p.rotation.y -= 0.0005;
                p.rotation.x += 0.0002;
            });
            renderer.render(scene, camera);
        }

        init3D();
    </script>
</body>
</html>
